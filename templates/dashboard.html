<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Financeiro - Lalabank</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        body { font-family: system-ui, sans-serif; margin: 0; background-color: #f8f9fa; color: #212529; }
        .container { max-width: 1600px; margin: auto; padding: 2em; }
        h1, h2, h3 { color: #343a40; }
        .summary, .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5em; margin-bottom: 2em; }
        .card { background-color: white; padding: 1.5em; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; }
        .card h3 { margin-top: 0; font-size: 1em; color: #6c757d; }
        .card p { font-size: 1.5em; font-weight: bold; margin-bottom: 0; }
        .receita { color: #198754; }
        .despesa { color: #dc3545; }
        .balanco { color: #0d6efd; }
        table { width: 100%; border-collapse: collapse; background-color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-top: 2em; }
        th, td { padding: 12px; border-bottom: 1px solid #dee2e6; text-align: left; vertical-align: middle; }
        th { background-color: #f8f9fa; font-weight: bold; }
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2em; }
        .chart-container, .settings-card { background-color: white; padding: 2em; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .chart-container h3 { text-align: center; margin-top: 0; }
        .tabs { border-bottom: 2px solid #dee2e6; margin-bottom: 2em; }
        .tab-link { padding: 1em 1.5em; display: inline-block; border: none; background: none; cursor: pointer; font-size: 1.1em; color: #6c757d; }
        .tab-link.active { font-weight: bold; color: #0d6efd; border-bottom: 2px solid #0d6efd; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .settings-list { list-style: none; padding: 0; max-height: 250px; overflow-y: auto; }
        .settings-list li { display: flex; justify-content: space-between; align-items: center; padding: 0.8em; border-bottom: 1px solid #eee; }
        .settings-list li span { font-size: 0.9em; color: #6c757d; margin-left: 1em; }
        .delete-btn { background-color: #dc3545; color: white; border: none; padding: 0.5em 0.8em; border-radius: 4px; cursor: pointer; }
        .save-btn { background-color: #198754; color: white; border: none; padding: 0.5em 0.8em; border-radius: 4px; cursor: pointer; }
        .form-group { margin-top: 1.5em; }
        .form-group input, .form-group select, .extrato-select { width: 100%; box-sizing: border-box; padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 0.5em;}
        .form-group button { width: 100%; padding: 10px; background-color: #0d6efd; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 0.5em; }
        .card-rules-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items: center;}
    </style>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1>Dashboard Financeiro</h1>
            <a href="{{ url_for('logout') }}" style="text-decoration: none; background-color: #6c757d; color: white; padding: 0.5em 1em; border-radius: 5px;">Sair</a>
        </div>
        <div class="tabs">
            <button class="tab-link" onclick="openTab(event, 'Dashboard')">Dashboard</button>
            <button class="tab-link" onclick="openTab(event, 'Extrato')">Extrato</button>
            <button class="tab-link" onclick="openTab(event, 'Configuracoes')">Configurações</button>
        </div>

        <div id="Dashboard" class="tab-content">
            </div>

        <div id="Extrato" class="tab-content">
            </div>

        <div id="Configuracoes" class="tab-content">
            <h2>Configurações</h2>
            <div class="settings-grid">
                <div class="settings-card">
                    <h3 title="Crie categorias e associe palavras-chave a elas. O bot usará isso para categorizar suas despesas automaticamente.">Gerir Categorias</h3>
                    <ul class="settings-list">
                        {% for nome, palavras in categorias_disponiveis.items() %}
                        <li title="Palavras-chave: {{ palavras|join(', ') }}">
                            <div>
                                <strong>{{ nome }}</strong><br>
                                <span>{{ palavras|join(', ') }}</span>
                            </div>
                            <button class="delete-btn" onclick="deleteCategory('{{ nome }}')">X</button>
                        </li>
                        {% endfor %}
                    </ul>
                    <form id="add-category-form" class="form-group">
                        <input type="text" id="new-category-name" placeholder="Nome da Categoria" required>
                        <input type="text" id="new-category-keywords" placeholder="Palavras-chave (ex: mercado, ifood)" required>
                        <button type="submit">Adicionar Categoria</button>
                    </form>
                </div>
                <div class="settings-card">
                    <h3 title="Adicione os nomes dos seus bancos (contas correntes) e cartões de crédito. O bot usará esses nomes para identificar de onde saiu o dinheiro.">Gerir Contas</h3>
                     <ul class="settings-list">
                        {% for conta in contas_disponiveis.contas %}
                        <li><strong>{{ conta }}</strong><button class="delete-btn" onclick="deleteAccount('{{ conta }}')">X</button></li>
                        {% endfor %}
                    </ul>
                     <form id="add-account-form" class="form-group">
                        <input type="text" id="new-account-name" placeholder="Nome da Conta (ex: Bradesco)" required>
                        <button type="submit">Adicionar Conta</button>
                    </form>
                </div>
                <div class="settings-card">
                    <h3 title="Defina um teto de gastos mensal para qualquer categoria. O bot irá te avisar sobre o progresso.">Gerir Metas</h3>
                     <ul class="settings-list">
                        {% for cat, val in metas.items() %}
                        <li><strong>{{ cat }}</strong><span>R$ {{ "%.2f"|format(val) }}</span><button class="delete-btn" onclick="deleteMeta('{{ cat }}')">X</button></li>
                        {% endfor %}
                    </ul>
                     <form id="add-meta-form" class="form-group">
                        <select id="meta-category" required>
                            {% for cat in categorias_disponiveis.keys() %}
                            <option value="{{ cat }}">{{ cat }}</option>
                            {% endfor %}
                        </select>
                        <input type="number" step="0.01" id="meta-value" placeholder="Valor da Meta" required>
                        <button type="submit">Adicionar Meta</button>
                    </form>
                </div>
                <div class="settings-card">
                    <h3 title="Informe o dia do fechamento e do vencimento da fatura de cada cartão para que o sistema possa calcular corretamente a previsão de faturas e os lembretes.">Regras dos Cartões</h3>
                    <form id="card-rules-form">
                        {% for cartao in contas_disponiveis.cartoes %}
                        <div class="form-group card-rules-grid">
                            <label for="fechamento-{{cartao}}">{{cartao}}:</label>
                            <div style="display: flex; gap: 5px;">
                                <input type="number" id="fechamento-{{cartao}}" placeholder="Dia Fecho." value="{{ regras_cartoes.get(cartao, {}).get('fechamento', '') }}" min="1" max="31">
                                <input type="number" id="vencimento-{{cartao}}" placeholder="Dia Venc." value="{{ regras_cartoes.get(cartao, {}).get('vencimento', '') }}" min="1" max="31">
                            </div>
                        </div>
                         {% endfor %}
                        <div class="form-group">
                            <button type="submit">Salvar Regras</button>
                        </div>
                    </form>
                </div>
                 <div class="settings-card">
                    <h3 title="Lembretes manuais que você registrou pelo WhatsApp. As faturas de cartão de crédito aparecerão aqui automaticamente.">Gerir Lembretes</h3>
                     <ul class="settings-list">
                        {% for lembrete in lembretes %}
                        <li>
                            <div>
                                <strong>{{ lembrete.descricao }}</strong><br>
                                <span>R$ {{ "%.2f"|format(lembrete.valor) }} - Vence dia {{ lembrete.dia_vencimento }}</span>
                            </div>
                            {% if lembrete.get('is_deletable', true) %}
                                <button class="delete-btn" onclick="deleteLembrete('{{ lembrete.timestamp }}')">X</button>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ... (todo o seu JavaScript permanece o mesmo) ...
    </script>
</body>
</html>
